# Development Guide

This guide is for contributors working on the add-in source code. For **installation instructions**, see [INSTALL.md](INSTALL.md).

## Prerequisites

- Node.js 18+
- npm
- Microsoft Excel (for testing)

## Setup

```bash
git clone https://github.com/OilpriceAPI/excel-energy-addin.git
cd excel-energy-addin
npm install
```

## Development Server

```bash
npm run dev
```

This starts a webpack dev server at `https://localhost:3000` with hot reload.

### Self-Signed Certificate

The dev server uses a self-signed HTTPS certificate (required by Office.js). On first run, your browser will show a security warning — click "Advanced" > "Proceed to localhost" to accept it.

To install the certificate system-wide:

```bash
sudo npx office-addin-dev-certs install --machine
```

Certificate files are stored in `~/.office-addin-dev-certs/`.

## Sideloading for Development

### From WSL (Windows)

The manifest in `dist/` points to localhost for development:

```
\\wsl$\Ubuntu\home\<user>\code\excel-energy-addin\dist\manifest.xml
```

Or copy to Windows:

```bash
cp dist/manifest.xml /mnt/c/Users/$USER/Desktop/
```

Then in Excel: **Insert** > **Get Add-ins** > **Upload My Add-in** > select the manifest.

### Production vs Dev Manifest

- `manifest.xml` (root) — points to GitHub Pages (`oilpriceapi.github.io`), used for production
- `dist/manifest.xml` — generated by build, points to `localhost:3000`, used for development

## Build

```bash
npm run build          # Production build to dist/
```

## Testing

```bash
npm test               # Run Jest unit tests
npm run test:coverage  # With coverage report
```

Current coverage: ~98%.

## Project Structure

```
src/
├── functions/
│   ├── functions.ts     # Custom Excel functions (=OILPRICE, etc.)
│   └── functions.json   # Function metadata for Office.js
├── utils/
│   ├── api-client.ts    # OilPriceAPI HTTP client
│   └── conversions.ts   # Energy unit conversion math
├── types/
│   └── user-tier.ts     # Plan tier definitions
└── index.ts             # Core Excel workbook operations

public/
├── taskpane.html        # Task pane UI
├── taskpane.js          # Task pane logic
└── taskpane.css         # Styles
```

## Deployment

The production add-in is hosted on GitHub Pages at `oilpriceapi.github.io/excel-energy-addin/`.

To deploy:

1. Run `npm run build`
2. Push to the `gh-pages` branch (or configure GitHub Actions)
3. The root `manifest.xml` already points to the GitHub Pages URLs

## Architecture

- **Shared Runtime**: The add-in uses Office.js Shared Runtime so custom functions and the taskpane share state
- **Storage**: API keys are stored in `OfficeRuntime.storage` (encrypted, per-user)
- **Streaming Functions**: `OILPRICE()` and `DIESEL_PRICE()` auto-refresh via `invocation.setResult()`
- **Tier Gating**: Historical data and some features check user plan tier before executing

## Debugging

1. In Excel Online, press F12 to open browser dev tools
2. In Excel Desktop, use the "Attach Debugger" option from the add-in menu
3. Console logs from `taskpane.js` and custom functions appear in the dev tools console
